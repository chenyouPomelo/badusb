#!/bin/sh
#set -x
#set -e

sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X
sudo iptables -t mangle -F
sudo iptables -t mangle -X

echo "Enter device name > "
read device

# bring the USB virtual Ethernet interface up
sudo /sbin/ip link set $device up

# set the host IP address
sudo /sbin/ip addr add 10.0.0.2/24 dev $device

# enable IP forwarding
echo "1" | sudo tee /proc/sys/net/ipv4/ip_forward

# add armory route
sudo ip route add 10.0.0.0/24 dev $device table arm-route #???
sudo ip route add default via 10.0.0.1 dev $device table arm-route

# add mark 1 for armory route
sudo ip rule add fwmark 1 table arm-route

sudo sysctl net.ipv4.conf.$device.rp_filter=0
sudo sysctl net.ipv4.conf.enp0s3.rp_filter=0
sudo sysctl net.ipv4.conf.all.rp_filter=0

#./enableLog.sh

# DEFINE RULES
#___________________________________________________________________________
#---------------------------------------------------------------------------
# MANGLE PREROUTING
#---------------------------------------------------------------------------


#---------------------------------------------------------------------------
# NAT PREROUTING
#---------------------------------------------------------------------------


#=============================SWITCH IP=====================================
#==========================CASE FORWARDING==================================
#---------------------------------------------------------------------------
# MANGLE FORWARD
#---------------------------------------------------------------------------

#---------------------------------------------------------------------------
# FILTER FORWARD
#---------------------------------------------------------------------------

#==============================BREAK========================================
#===========================CASE ROUTING====================================

#---------------------------------------------------------------------------
# MANGLE INPUT
#---------------------------------------------------------------------------


#---------------------------------------------------------------------------
# FILTER INPUT
#---------------------------------------------------------------------------


#==============================BREAK========================================
#===========================END SWITCH======================================
#=========================IF LOCAL PROCESS==================================

#---------------------------------------------------------------------------
# MANGLE OUTPUT
#---------------------------------------------------------------------------

sudo iptables -A OUTPUT -t mangle ! -s 10.0.0.1 -j MARK --set-mark 1

#---------------------------------------------------------------------------
# NAT OUTPUT
#---------------------------------------------------------------------------

#---------------------------------------------------------------------------
# FILTER OUTPUT
#---------------------------------------------------------------------------

#============================END IF=========================================
#===========================================================================

#---------------------------------------------------------------------------
# MANGLE POSTROUTING
#---------------------------------------------------------------------------

#---------------------------------------------------------------------------
# NAT POSTROUTING
#---------------------------------------------------------------------------

sudo iptables -t nat -A POSTROUTING -s 10.0.0.1/32 -j MASQUERADE

#___________________________________________________________________________

sudo ip route flush cache

./showInfo.sh
